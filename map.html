<!DOCTYPE html>
<html>
	<meta charset="utf-8" />
	<style>
		svg {
			width: 800px;
			height: 800px;
		}
	</style>

	<body>
		<div id="controls">
			<label for="severityFilter">Filter by severity:</label>
			<select id="severityFilter">
				<option value="all">All</option>
				<option value="2">Severity 2</option>
				<option value="4">Severity 4</option>
			</select>
		<label for="startTimeSlider"> Filter by start time:</label>
			<input id="startTimeSlider" type="range" min="0" max="23" value="0">
			<span id="timeDisplay">12:00 AM</span>
		<button id="showAllTimesBtn">Show All Times</button>
		</div>
		<svg></svg>
	</body>

	<script src="http://d3js.org/d3.v6.min.js"></script>

	<script>
		//        ------------------------ SET UP canvas --------------------------
		var margin = { top: 20, right: 20, bottom: 20, left: 20 },
			width = +400 - margin.left - margin.right,
			height = +400 - margin.top - margin.bottom;

		var svg = d3
			.select('svg')
			.attr('width', width + margin.left + margin.right)
			.attr('height', height + margin.top + margin.bottom);

		//        ------------------------ SET UP OUR GEOJSON Layer --------------------------
		//projection coverts geojson coords to svg coords
		var projection = d3
			.geoAlbersUsa()
			.scale(4000)
			.translate([width / 20 - 400, height / 20 - 400]);

		//geopath coverts geojson geometry to svg path
		//projection here is func we use to convert geometry points into svg points
		var path = d3.geoPath().projection(projection);

		//        ------------------------ SET UP OUR Map Layer --------------------------
		var statesLayer = svg.append('g').attr('class', 'states');
		d3.json('FLmap.json').then(function (us) {
			//inside of the svg layer we made we will select all paths (on first pass this is none)
			statesLayer
				.selectAll('path')
				//then we bind the path objects to our features
				.data(us.features)
				//now we enter the new data and append a path for each feature
				.enter()
				.append('path')
				//styling for the path
				.attr('d', path)
				.attr('stroke', '#000000')
				.attr('fill', '#ffffff')
				.attr('opacity', 0.7)
				//new handler for clicking on county
				.on('click', countyClicked);
		});

		//        ------------------------ SET UP OUR Crashes Layer --------------------------

		var allPoints = [];

		var crashesLayer = svg.append('g').attr('class', 'crashes');
		//grab the data json file and execute function with resulting data
		d3.json('FLdata.json')
			.then(function (points) {
				//grab the array of features
				allPoints = points.features;
				updateAndFilterPoints();
			})
			.catch((error) => {
				console.error('Error loading:', error);
			});

		//        ------------------------ SET UP handlers  --------------------------
		let activeCounty = null;
		function countyClicked(event, county) {
			//this keyword grabs the dom element clicked
			const countyElement = this;
			//if county is active and the same as the county clicked we zoom out
			if (activeCounty && activeCounty === county) {
				// zoom out
				statesLayer.transition().duration(750).attr('transform', '');
				crashesLayer.transition().duration(750).attr('transform', '');
				activeCounty = null;
				updateAndFilterPoints();
			} else {
				activeCounty = county;
				//get bounds of country from the path
				boundingbox = countyElement.getBBox();
				const centerX = boundingbox.x;
				const centerY = boundingbox.y;
				const countyWidth = boundingbox.width
				const countyHeight = boundingbox.height

				//scale the map to the bounding box
				const scale = 1 / Math.max(countyWidth / width, countyHeight / height);
				const translate = [width / 2 - scale * centerX, height / 2 - scale * centerY];

				const transformString = `translate(${translate}) scale(${scale})`;

				statesLayer
					.transition()
					.duration(750)
					.attr('transform', transformString);

				crashesLayer
					.transition()
					.duration(750)
					.attr('transform', transformString);

				updateAndFilterPoints();
			}
		}

		//        ------------------------ render + update functions  --------------------------

		// helper function that draws the circles based on a given dataset
		function renderPoints(data) {
			crashesLayer
				//grab all circles from the svg and bind them to the features (passed in data)
				.selectAll('circle')
				.data(data)

				//draw a circle at the specified coordinates
				.join('circle')
				.attr('cx', (d) => projection(d.geometry.coordinates)[0])
				.attr('cy', (d) => projection(d.geometry.coordinates)[1])
				.attr('r', 1)
				.attr('stroke', '#666666')
				.attr('fill', '#888888')
				.attr('opacity', 0.7)
				//TODO: change this to be a function that meta info about point 
				.on('mouseover', function () {
					d3.select(this)
						.attr('fill', 'red')
						.attr('stroke', 'red')
						.attr('r', 4);
				})
				.on('mouseout', function () {
					d3.select(this)
						.attr('stroke', '#666666')
						.attr('fill', '#888888')
						.attr('r', 1);
				});
		}


		//initial filtering settings
		let currentSeverity = 'all';
		let currentTime = 0
		let filterByTime = false;

		function updateAndFilterPoints() {
			let filteredPoints = allPoints;

			//filter by active county
			if (activeCounty) {
				filteredPoints = filteredPoints.filter((point) =>
					d3.geoContains(activeCounty, point.geometry.coordinates)
				);
			}

			//filter by severity
			if (currentSeverity !== 'all') {
				filteredPoints = filteredPoints.filter(
					(point) => String(point.properties.severity) === currentSeverity
				);
			}

			//filter by starttime if filtering enabled
			if (filterByTime) {
				filteredPoints = filteredPoints.filter((point) => {
					const timeString = point.properties.starttime[0];
					const hour = parseInt(timeString.split(' ')[1].split(':')[0]);
					return hour === currentTime;
				});
			}

			renderPoints(filteredPoints);

		}

		setupFilters();
		setupSliders();
		setupButtons()
		
		//        ------------------------ Connect Html ui with functions --------------------------
		function setupFilters() {
			d3.select('#severityFilter').on('change', function () {
				currentSeverity = this.value;
				console.log(currentSeverity);
				updateAndFilterPoints();
			});
		}

		function setupSliders() {
			d3.select('#startTimeSlider').on('input', function () {
				currentTime = parseInt(this.value);
				filterByTime = true; 
				
				let displayHour = currentTime;
				let period = 'AM';
				
				if (currentTime === 0) {
					displayHour = 12;
				} else if (currentTime === 12) {
					displayHour = 12;
					period = 'PM';
				} else if (currentTime > 12) {
					displayHour = currentTime - 12;
					period = 'PM';
				}
				
				const displayText = displayHour + ':00 ' + period;
				d3.select('#timeDisplay').text(displayText);
				updateAndFilterPoints();
			});
		}

		function setupButtons() {
			d3.select('#showAllTimesBtn').on('click', function () {
				filterByTime = false;
				updateAndFilterPoints();
			});
		}


	</script>
</html>
